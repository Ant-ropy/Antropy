<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Provably-Fair Coin Flip (Bitstream Backed)</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#64748b;--accent:#1e40af;--ok:#15803d;--bad:#b91c1c;--ring:#e2e8f0}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    h1{font-size:24px;margin:0 0 16px} h2{font-size:18px;margin:24px 0 8px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;box-shadow:0 2px 8px rgba(15,23,42,.04)}
    .card .pad{padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="number"], input[type="text"], textarea{width:100%;border:1px solid var(--ring);border-radius:10px;padding:10px 12px;background:white}
    textarea{height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    .row{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--ring);background:#0ea5e9;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#e2e8f0;color:#0f172a}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--ring);text-align:left;font-size:13px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--ring);font-size:11px;background:#f8fafc}
    .good{color:var(--ok)} .bad{color:var(--bad)}
    .commit{word-break:break-all;background:#f1f5f9;border-radius:8px;padding:8px;font-size:12px}
    .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#f8fafc;border:1px solid var(--ring);padding:2px 6px;border-radius:6px}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Provably‑Fair Coin Flip <span class="pill mono">Static HTML • No libs</span></h1>
    <div class="grid">
      <div class="card">
        <div class="pad">
          <h2>Play</h2>
          <div class="row" style="margin:8px 0 12px">
            <button id="pick-heads" class="btn">Pick: HEADS</button>
            <button id="pick-tails" class="btn secondary">Pick: TAILS</button>
            <span class="muted">Current pick: <strong id="pick-label">HEADS</strong></span>
          </div>
          <div class="row" style="margin:0 0 12px">
            <label style="margin:0">Wager (£)</label>
            <input id="wager" type="number" min="1" value="5" style="max-width:120px" />
            <span class="muted">Balance: <strong id="balance">£100.00</strong></span>
          </div>
          <div class="row" style="margin:0 0 16px">
            <button id="flip" class="btn">Flip coin</button>
            <button id="reset" class="btn secondary">Reset demo</button>
            <span class="muted">Usable pairs remaining: <span class="mono" id="pairs">0</span></span>
          </div>

          <div class="card" style="border-style:dashed">
            <div class="pad">
              <div class="muted" style="margin-bottom:6px">Provability</div>
              <div class="note">At load, we compute <span class="kbd">SHA‑256</span> of your full bitstream. Each flip consumes bits in order using a Von Neumann extractor (01→HEADS, 10→TAILS; 00/11 discarded). Download the audit log and later reveal the full bitstream so anyone can recompute every flip.</div>
              <div style="margin-top:8px">
                <div class="muted">Commitment (SHA‑256 of full bitstream):</div>
                <div id="commit" class="commit mono">—</div>
              </div>
            </div>
          </div>

          <h2>Recent flips</h2>
          <div style="max-height:300px;overflow:auto;border:1px solid var(--ring);border-radius:10px">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Idx</th>
                  <th>Bits</th>
                  <th>Pick</th>
                  <th>Outcome</th>
                  <th>Δ</th>
                  <th>Balance</th>
                </tr>
              </thead>
              <tbody id="log">
                <tr><td colspan="7" class="muted" style="text-align:center;padding:16px">No flips yet</td></tr>
              </tbody>
            </table>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="download" class="btn secondary">Download audit JSON</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="pad">
          <h2>Bitstream</h2>
          <label for="bits">Paste your raw bitstream (0/1 only)</label>
          <textarea id="bits" placeholder="e.g., 0100110101…"></textarea>
          <div class="note">Length: <span class="mono" id="bitlen">0</span> bits</div>
          <p class="note" style="margin-top:8px">
            <strong>How this stays fair:</strong> commitment first, then sequential consumption with a bias‑neutral extractor. When usable pairs run out, load a longer sequence (fresh entropy). For real‑money use you must implement server‑side indexing and jurisdictional compliance (age gating, KYC/AML, limits, licensing).
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
// ————— Utilities —————
function fmtGBP(v){return new Intl.NumberFormat(undefined,{style:"currency",currency:"GBP"}).format(v)}
async function sha256Hex(str){const enc=new TextEncoder();const buf=await crypto.subtle.digest('SHA-256',enc.encode(str));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')}
function nextVNOutcome(bits,startIdx){let i=startIdx;const n=bits.length;while(i+1<n){const a=bits[i],b=bits[i+1];if(a!==b){return { outcome: (a==='0'&&b==='1')? 'HEADS':'TAILS', nextIndex:i+2, consumed:bits.slice(startIdx,i+2)} } i+=2 } return { outcome:null, nextIndex:n, consumed:bits.slice(startIdx,n) } }

// ————— State —————
let pick='HEADS';
let balance=100; // demo credits
let wager=5;
let bitstream='';
let index=0; // cursor in raw bits
let audit=[]; // newest first

// ————— DOM —————
const $ = (id)=>document.getElementById(id);
const elPickH=$('pick-heads'), elPickT=$('pick-tails'), elPickL=$('pick-label');
const elWager=$('wager'), elBalance=$('balance'), elPairs=$('pairs');
const elFlip=$('flip'), elReset=$('reset');
const elBits=$('bits'), elBitLen=$('bitlen'), elCommit=$('commit');
const elLog=$('log'), elDownload=$('download');

function renderMeta(){ elBalance.textContent=fmtGBP(balance); elPairs.textContent=Math.floor((bitstream.length-index)/2); elPickL.textContent=pick; }
function renderLog(){
  elLog.innerHTML = '';
  if(audit.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=7; td.className='muted'; td.style.textAlign='center'; td.style.padding='16px'; td.textContent='No flips yet'; tr.appendChild(td); elLog.appendChild(tr); return; }
  for(const a of audit){ const tr=document.createElement('tr');
    const cells=[ new Date(a.ts).toLocaleTimeString(), `${a.indexBefore}→${a.indexAfter}`, a.consumedBits, a.playerPick[0], a.outcome, a.result, fmtGBP(a.balanceAfter) ];
    cells.forEach((c,i)=>{ const td=document.createElement('td'); td.textContent=c; if(i===5){ td.className = a.result.startsWith('+')?'good':'bad'; } if(i===2){ td.className='mono'; } tr.appendChild(td); });
    elLog.appendChild(tr);
  }
}

async function recomputeCommit(){ elCommit.textContent = bitstream.length? await sha256Hex(bitstream) : '—'; }

// ————— Events —————
elPickH.addEventListener('click',()=>{pick='HEADS'; elPickH.classList.remove('secondary'); elPickT.classList.add('secondary'); renderMeta()});
elPickT.addEventListener('click',()=>{pick='TAILS'; elPickT.classList.remove('secondary'); elPickH.classList.add('secondary'); renderMeta()});

elWager.addEventListener('input',()=>{ const v = Math.max(1, Number(elWager.value||1)); wager=v; elWager.value=v; });

elBits.addEventListener('input', async ()=>{ bitstream = (elBits.value||'').replace(/[^01]/g,''); elBits.value = bitstream; index=0; audit=[]; elBitLen.textContent = bitstream.length; await recomputeCommit(); renderMeta(); renderLog(); });

elFlip.addEventListener('click', ()=>{
  if(!bitstream){ alert('Paste a bitstream first.'); return; }
  if(wager<1){ alert('Wager must be at least 1.'); return; }
  if(balance < wager){ alert('Insufficient balance.'); return; }
  const { outcome, nextIndex, consumed } = nextVNOutcome(bitstream, index);
  if(!outcome){ alert('Not enough usable pairs remain (Von Neumann discards 00/11). Load more bits.'); return; }
  const win = (outcome===pick);
  balance = win ? balance + wager : balance - wager;
  const entry = { ts:new Date().toISOString(), indexBefore:index, indexAfter:nextIndex, consumedBits:consumed, outcome, playerPick:pick, wager, result: (win?'+':'-')+wager, balanceAfter:balance };
  audit = [entry, ...audit];
  index = nextIndex;
  renderMeta(); renderLog();
});

elReset.addEventListener('click',()=>{ balance=100; wager=5; index=0; audit=[]; elWager.value='5'; renderMeta(); renderLog(); })

elDownload.addEventListener('click',()=>{
  const payload = { committedHash: elCommit.textContent, bitLength: bitstream.length, extraction: 'Von Neumann (pairs; 01=H, 10=T)', audit: audit.slice().reverse() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='coinflip_audit.json'; a.click(); URL.revokeObjectURL(url);
});

// initial render
renderMeta(); renderLog();
</script>
</body>
</html>
